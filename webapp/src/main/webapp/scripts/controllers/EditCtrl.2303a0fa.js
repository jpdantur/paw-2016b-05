define(["siglasApp","services/ItemService","services/CategoryService"],function(siglasApp){siglasApp.controller("EditCtrl",["$scope","$rootScope","$location","$q","$route","ItemService","CategoryService","toastr","$filter",function($scope,$rootScope,$location,$q,$route,ItemService,CategoryService,toastr,$filter){function dataURItoBlob(dataURI,mimeString){for(var byteString=atob(dataURI),ia=new Uint8Array(byteString.length),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return new Blob([ia],{type:mimeString})}function itemCategoryLookup(categories,depth){_.each(categories,function(category){if(!stop){if(category.id===self.item.category.id)return stop=!0,selectCategory(category,depth);selectCategory(category,depth),itemCategoryLookup(category.children,depth+1)}})}function switchToTab(tab){$location.search({tab:tab}),self.selectedTab=tab}function selectCategory(category,depth){category.children.length?(self.selectedCategory=null,self.categoryPath.splice(depth,self.categoryPath.length-depth,category.children)):(self.selectedCategory=category,self.categoryPath.splice(depth,self.categoryPath.length-depth)),self.highlighted=_.map(self.categoryPath,function(group){return group[0].parent})}function submit(valid){valid&&(_.extend(self.item,{category:self.selectedCategory.id}),ItemService.update(self.item).then(function(result){toastr.success($filter("translate")("ng.messages.editSuccess"))},function(err){console.error(err),toastr.error($filter("translate")("ng.messages.editError"))}))}function remove(index){self.item.images.splice(index,1)}function submit2(){ItemService.uploadImage(id,self.item.images).then(function(results){toastr.success($filter("translate")("ng.messages.imageSuccess"))},function(err){toastr.error($filter("translate")("ng.messages.imageError")),console.error($filter("translate")("ng.messages.imageError"))})}var self=this,id=$route.current.pathParams.id;$scope._=_,self.selectedTab=$route.current.params.tab||"details",self.switchToTab=switchToTab,self.item=null,self.categoryPath=[],self.highlighted=[],self.selectedCategory=null,self.selectCategory=selectCategory,self.submit=submit,self.remove=remove,self.submit2=submit2,$q.all({item:ItemService.findById(id),category:CategoryService.tree()}).then(function(result){self.item=result.item,self.item.images=_.map(self.item.images,function(image){return dataURItoBlob(image.content,image.mimeType)}),self.categories=result.category,self.categoryPath.push(self.categories),itemCategoryLookup(self.categories,1)},function(err){console.error(err)});var stop=!1}])});