define(["siglasApp","services/StoreService"],function(siglasApp){siglasApp.controller("AllCtrl",["$scope","$rootScope","$location","$route","toastr","$filter","StoreService",function($scope,$rootScope,$location,$route,toastr,$filter,StoreService){function updateItemsQuery(delta){_.extend(self.itemsQuery,delta),publishedItems()}function onItemsOrderChange(){var parts=self.itemsOrder.split("-");updateItemsQuery({pageNumber:0,sortOrder:parts[1],sortField:parts[0]})}function publishedItems(){self.itemsLoading=!0,lock=!0,StoreService.search(self.itemsQuery).then(function(result){return self.itemResult=result,self.itemsLoading=!1,1===self.itemResult.results.length?$location.search({}).path("/store/items/"+self.itemResult.results[0].id):(self.displayedCategories=self.itemResult.selectedCategories,self.displayedCategoriesG=_.reduce(self.displayedCategories,function(memo,val){return memo[val.id]=val,memo},{}),$location.search(self.itemsQuery),void setTimeout(function(){lock=!1},50))},function(err){console.error(err)})}function toggleCategory(category){var idx=_.findIndex(self.selectedCategories,{id:category.id});~idx?self.selectedCategories.splice(idx,1):self.selectedCategories.push(category)}function applyCategory(){updateItemsQuery({pageNumber:0,categories:_.map(self.selectedCategories,"id")}),self.selectedCategories=[]}function removeCategory(category){var idx=_.findIndex(self.displayedCategories,{id:category.id});self.displayedCategories.splice(idx,1),updateItemsQuery({pageNumber:0,categories:_.map(self.displayedCategories,"id")}),self.selectedCategories=[]}$scope._=_,$scope.Math=window.Math;var lock=!0,self=this;self.itemsQuery=_.extend({pageNumber:0,pageSize:20,query:"",sortOrder:"ASC",sortField:"PRICE",minPrice:null,maxPrice:null,categories:[]},_.mapValues($location.search(),function(val){return val&&isFinite(val)?parseInt(val,10):val})),self.displayedCategories=[],self.displayedCategoriesG={},self.selectedCategories=[],self.itemsLoading=!1,self.itemResult={},self.itemsOrder="PRICE-ASC",self.updateItemsQuery=_.debounce(updateItemsQuery,500),self.onItemsOrderChange=onItemsOrderChange,self.toggleCategory=toggleCategory,self.applyCategory=applyCategory,self.removeCategory=removeCategory,$scope.$on("query.update",function(e,query){updateItemsQuery({pageNumber:0,query:query})}),$scope.$watch(function(){return $location.search()},function(){lock||(self.itemsQuery=_.extend({pageNumber:0,pageSize:20,query:"",sortOrder:"ASC",sortField:"PRICE",minPrice:null,maxPrice:null,categories:[]},_.mapValues($location.search(),function(val){return val&&isFinite(val)?parseInt(val,10):val})),publishedItems())}),publishedItems()}])});